////////////////////////////////////////////////////////////////////////////////
//  此脚本用于寻找硅条望远镜径迹重建的算法, 对 globalmulti = 1, 2, 3, 4, 6 共
//  5 中情况进行解码
//
//  gfh, 2021-08-09
////////////////////////////////////////////////////////////////////////////////
#include "../include/L2L3TrackFinding.h"


//______________________________________________________________________________
//                        fGlobalMulti = 1
//                    ------------------------
DecodefGlobalMulti1::DecodefGlobalMulti1(Int_t firstrun, Int_t lastrun)
{
  fFirstRun = firstrun;
  fLastRun  = lastrun;

  trackreconstruct = new CSHINETrackReconstruction(fFirstRun, fLastRun);

  std::string pathBananaCut(Form("%sStraighteningData/L2L3DEECuts.root",PATHROOTFILESFOLDER));
  TFile* myfile = TFile::Open(pathBananaCut.c_str());
  // 读取 bananacut
  for (Int_t numtel=0; numtel<NUM_SSD*NUM_CSI; numtel++) {
    TIter next(myfile->GetListOfKeys());
    TKey* key;
    while ((key = (TKey*) next())) {
      TCutG* cut = (TCutG*) key->ReadObj();
      std::string cutname(cut->GetName());

      if (strstr(cutname.c_str(), Form("_Tel%02d_",numtel)) != NULL) {
        bananacut[numtel].push_back(cut);
      //  cout<<cut->GetName()<<endl;
      }
    }
  }
}

DecodefGlobalMulti1::~DecodefGlobalMulti1()
{}

//_______________________________________________
// 对 globalmulti = 1 的事件进行综合检查
// (1)平行坐标表示, 检验层间关系是否有误
// (2)检查 fGlobalMulit = 1 事件的 DE-E plot
void DecodefGlobalMulti1::GlobalMulti1_Checks()
{
  gROOT->cd();

  Int_t gmulti = 1;
  const char* gmultitag = "fGlobalMulti1";
  trackreconstruct->L2L3_CheckParallelDraw(gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL2L3DEEPlot (gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL1L2DEEPlot (gmultitag, gmulti);
}


//_______________________________________________________________
// 对 globalmulti = 1 的情况进行解析
// 解析内容包括:
//  增加约束条件 4: IsEneConstraint_L2B_L2F()
//  增加约束条件 5: IsEneConstraint_L1S_L2F()
//  增加约束条件 6: BananaCut.IsInside(EL2F, ECsI);
void DecodefGlobalMulti1::GlobalMulti1_L2L3_Decode()
{
  Int_t globalmulti = 1;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode.pdf",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode.pdf[",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode.pdf]",PATHFIGURESFOLDER,globalmulti));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti",ssdindex+1), Form("SSD%d_CandiMulti",ssdindex+1), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged",ssdindex+1), Form("SSD%d_CandiMulti_Merged",ssdindex+1), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat",ssdindex+1,csiindex), Form("SSD%d_CsI%d_ModeStat",ssdindex+1,csiindex), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected",ssdindex+1,csiindex), Form("SSD%d_CsI%d_SubmodeCorrected",ssdindex+1,csiindex), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti",ssdindex+1,csiindex), Form("SSD%d_CsI%d_CandiMulti",ssdindex+1,csiindex), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L2L3",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L2L3_Cuts",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L2L3_Discard",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L1L2",ssdindex+1,csiindex),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L1L2_Cuts",ssdindex+1,csiindex),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_L1L2_Discard",ssdindex+1,csiindex),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(500000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        for (Int_t itrack=0; itrack<globalmulti; itrack++) {
          h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
          h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

          // 填充 mode statistic
          bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
          h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

          if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
              trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
              trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
          {
            candimulti_sum[ssdindex]++;
            candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
          }
        }
        //____________________________________________________________________
        //           以下部分为当前 L2L3-globalomulti1 的径迹重建策略！！！
        //          -------------------------------------------------------
        if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
        {
          h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][0]]->Fill(bin_index[0]);
          // L2L3_DEE 直接填充
          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);

          // 如果满足 EL1S_EL2F, 则直接填充
          if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
            h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
          }
          else {
            // 利用 LISE++ 反推 L1S_ELoss
            trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
            if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
              L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
              if (L2F_Einc > Condition_L2FEincCut) {
                L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
              }
            }
          }
        }
        else {
          h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }
        //______________________________________________________________________
        // 填充每块 CsI 的 candidate multi
        for (Int_t itrack=0; itrack<globalmulti; itrack++) {
          h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
        }
        // 填充每一个 SSD 的 candidate multi
        h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}

//______________________________________________________________________________
// 查看径迹重建中扔掉的事件，看看是否有 “好的”事件被丢掉了
void DecodefGlobalMulti1::GlobalMulti_L2L3_Discard()
{
  Int_t globalmulti = 1;
  Int_t ssdnum, csinum, bananacut_telnum;
  Double_t el1s, el2f, el2b, ecsi;
  Int_t MAXPARTICLES = 20;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Discard.pdf",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Discard.pdf[",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Discard.pdf]",PATHFIGURESFOLDER,globalmulti));

  TH2F h2_L2L3_Geo[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_EneL2BL2F_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_EneL1SL2F_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_PID_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_Geo[NUM_SSD];
  TH2F h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[NUM_SSD];
  TH2F h2_L1L2_Geo_EneL2BL2F_Discard[NUM_SSD];
  TH2F h2_L1L2_Geo_EneL1SL2F_Discard[NUM_SSD];
  TH2F h2_L1L2_Geo_PID_Discard[NUM_SSD];
  TH2F h2_L1L2_Discard[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_Geo[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo_EnenL2BL2F_EneL1SL2F_PID",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo_EnenL2BL2F_EneL1SL2F_PID",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo_EneL2BL2F_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo_EneL2BL2F_Discard",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo_EneL1SL2F_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo_EneL1SL2F_Discard",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_Geo_PID_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo_PID_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo_PID_Discard",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Discard",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Discard",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
    }
    h2_L1L2_Geo[ssdindex] = TH2F(Form("SSD%d_Geo",ssdindex+1),Form("SSD%d_Geo",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex] = TH2F(Form("SSD%d_Geo_EneL2BL2F_EneL1SL2F_PID",ssdindex+1),Form("SSD%d_Geo_EneL2BL2F_EneL1SL2F_PID",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    h2_L1L2_Geo_EneL2BL2F_Discard[ssdindex] = TH2F(Form("SSD%d_Geo_EneL2BL2F_Discard",ssdindex+1),Form("SSD%d_Geo_EneL2BL2F_Discard",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    h2_L1L2_Geo_EneL1SL2F_Discard[ssdindex] = TH2F(Form("SSD%d_Geo_EneL12L2F_Discard",ssdindex+1),Form("SSD%d_Geo_EneL12L2F_Discard",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    h2_L1L2_Geo_PID_Discard[ssdindex] = TH2F(Form("SSD%d_Geo_PID_Discard",ssdindex+1),Form("SSD%d_Geo_PID_Discard",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    h2_L1L2_Discard[ssdindex] = TH2F(Form("SSD%d_Discard",ssdindex+1),Form("SSD%d_Discard",ssdindex+1),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
  }

  //trackreconstruct->fChainTrackTree->SetEntries(1000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }

      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        h2_L2L3_Geo[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
        h2_L1L2_Geo[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);

        // 考虑能量约束条件+PID cut
        if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
            trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]], L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]))
        {
          h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }

        // 不满足 L2B_L2F 能量关联
        if (!(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]))) {
          h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_Geo_EneL2BL2F_Discard[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }
        // 不满足 L2B_L2F 能量关联
        if (!(trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]))) {
          h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_Geo_EneL1SL2F_Discard[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }
        // 不满足 PID 约束
        if (!(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]], L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))) {
          h2_L2L3_Geo_PID_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_Geo_PID_Discard[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }
        // 考察所有丢掉的事件
        if (!(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
              trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
              trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])))
        {
          h2_L2L3_Discard[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          h2_L1L2_Discard[ssdindex].Fill(L2L3_L2FEMeV[ssdindex][0], L2L3_L1SEMeV[ssdindex][0]);
        }
      }
    }
  }
  // 画图
  TCanvas* c_begin = new TCanvas("c_begin","c_begin",600,600);
  TCanvas* c_end   = new TCanvas("c_end","c_end",600,600);
  TCanvas* cans_L2L3 = new TCanvas("cans_L2L3","cans_L2L3",1500,1000);
  cans_L2L3->Divide(3,2);
  TCanvas* cans_L1L2 = new TCanvas("cans_L1L2","cans_L1L2",1500,1000);
  cans_L1L2->Divide(3,2);

  c_begin->Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    cans_L1L2->cd(1);
    h2_L1L2_Geo[ssdindex].Draw("COL");
    h2_L1L2_Geo[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Geo[ssdindex].GetYaxis()->SetNdivisions(506);

    cans_L1L2->cd(2);
    h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex].Draw("COL");
    h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex].GetYaxis()->SetNdivisions(506);

    cans_L1L2->cd(3);
    h2_L1L2_Discard[ssdindex].Draw("COL");
    h2_L1L2_Discard[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Discard[ssdindex].GetYaxis()->SetNdivisions(506);

    cans_L1L2->cd(4);
    h2_L1L2_Geo_EneL2BL2F_Discard[ssdindex].Draw("COL");
    h2_L1L2_Geo_EneL2BL2F_Discard[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Geo_EneL2BL2F_Discard[ssdindex].GetYaxis()->SetNdivisions(506);

    cans_L1L2->cd(5);
    h2_L1L2_Geo_EneL1SL2F_Discard[ssdindex].Draw("COL");
    h2_L1L2_Geo_EneL1SL2F_Discard[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Geo_EneL1SL2F_Discard[ssdindex].GetYaxis()->SetNdivisions(506);

    cans_L1L2->cd(6);
    h2_L1L2_Geo_PID_Discard[ssdindex].Draw("COL");
    h2_L1L2_Geo_PID_Discard[ssdindex].GetXaxis()->SetNdivisions(506);
    h2_L1L2_Geo_PID_Discard[ssdindex].GetYaxis()->SetNdivisions(506);

    gPad->Modified();
    gPad->Update();

    cans_L1L2->Print(pathPDFOut.c_str());

    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans_L2L3->cd(1);
      h2_L2L3_Geo[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(2);
      h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_EneL12L2F_PID[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(3);
      h2_L2L3_Discard[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Discard[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Discard[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(4);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(5);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(6);
      h2_L2L3_Geo_PID_Discard[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo_PID_Discard[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_PID_Discard[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      gPad->Modified();
      gPad->Update();

      cans_L2L3->Print(pathPDFOut.c_str());
    }
  }
  c_end->Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// 考察 EneL2BL2F 能量约束条件对 "丢弃"事件的影响
void DecodefGlobalMulti1::GlobalMulti_L2L3_EneL2BL2F_Discard()
{

  Int_t globalmulti = 1;
  Int_t ssdnum, csinum, bananacut_telnum;
  Double_t el1s, el2f, el2b, ecsi;
  Int_t MAXPARTICLES = 20;

  Int_t nratio = 5;
  Double_t EL2BL2FRatio[5] = {0.20,0.30,0.40,0.50,0.60};
  Double_t lost_ratio[NUM_SSD][NUM_CSI][5] = {{{0}}};
  Double_t lost_ratio_ave[NUM_SSD][NUM_CSI] = {{0}};
  Double_t lost_ratio_sum[NUM_SSD][NUM_CSI] = {{0}};
  Double_t lost_ratio_csi_sum[NUM_CSI][5] = {{0}};
  Double_t lost_ratio_csi_ave[NUM_CSI][5] = {{0}};

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_EneL2BL2F_GlobalMulti%d_Discard.pdf",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_EneL2BL2F_GlobalMulti%d_Discard.pdf[",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_EneL2BL2F_GlobalMulti%d_Discard.pdf]",PATHFIGURESFOLDER,globalmulti));

  TH2F h2_L2L3_Geo[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_EneL2BL2F_Discard[NUM_SSD][NUM_CSI][5];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_Geo[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      for (Int_t iratio=0; iratio<nratio; iratio++) {
          h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][iratio] = TH2F(Form("SSD%d_CsI%d_Geo_EneL2BL2F%.2f_Discard",ssdindex+1,csiindex,EL2BL2FRatio[iratio]),
            Form("SSD%d_CsI%d_Geo_EneL2BL2F%.2f_Discard",ssdindex+1,csiindex,EL2BL2FRatio[iratio]),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      }
    }
  }

  // trackreconstruct->fChainTrackTree->SetEntries(1000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        h2_L2L3_Geo[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
        // 不满足 L2B_L2F 能量关联
        for (Int_t iratio=0; iratio<nratio; iratio++) {
          if (!(trackreconstruct->IsEneConstraint_L2B_L2F(L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0], EL2BL2FRatio[iratio]))) {
            h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][L2L3_CsINum[ssdindex][0]][iratio].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          }
        }
      }
    }
  }

  // 计算“丢失”事件的比例
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      for (Int_t iratio=0; iratio<nratio; iratio++) {
        lost_ratio[ssdindex][csiindex][iratio] = (Double_t) h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][iratio].GetEntries()/h2_L2L3_Geo[ssdindex][csiindex].GetEntries()*100;
        lost_ratio_sum[ssdindex][csiindex] += lost_ratio[ssdindex][csiindex][iratio];
      }
      lost_ratio_ave[ssdindex][csiindex] = lost_ratio_sum[ssdindex][csiindex]/nratio;
    }
  }

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t iratio=0; iratio<nratio; iratio++) {
      for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
        lost_ratio_csi_sum[ssdindex][iratio] += lost_ratio[ssdindex][csiindex][iratio];
      }
      lost_ratio_csi_ave[ssdindex][iratio] = lost_ratio_csi_sum[ssdindex][iratio]/NUM_CSI;
      cout<<Form("SSD%d_L2L3_Ratio%.2f = %.4f",ssdindex+1,EL2BL2FRatio[iratio],lost_ratio_csi_ave[ssdindex][iratio])<<endl;
    }
  }

  // 定义 latex
  TLatex* latex_ratio[NUM_SSD][NUM_CSI][nratio];
  TLatex* latex_ratio_ave[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      Double_t x1 = 0.3 * h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->GetXmax();
      Double_t y1 = 0.9 * h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->GetXmax();
      Double_t x2 = 0.3 * h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->GetXmax();
      Double_t y2 = 0.8 * h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->GetXmax();
      latex_ratio_ave[ssdindex][csiindex] = new TLatex(x1, y1, Form("#bar{r_{lost}} = %.4f%%",lost_ratio_ave[ssdindex][csiindex]));
      latex_ratio_ave[ssdindex][csiindex]->SetTextSize(0.05);
      latex_ratio_ave[ssdindex][csiindex]->SetTextColor(kRed);

      for (Int_t iratio=0; iratio<nratio; iratio++) {
        latex_ratio[ssdindex][csiindex][iratio] = new TLatex(x2, y2, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex][csiindex][iratio]));
        latex_ratio[ssdindex][csiindex][iratio]->SetTextSize(0.05);
        latex_ratio[ssdindex][csiindex][iratio]->SetTextColor(kRed);
      }
    }
  }

  // 画图
  TCanvas* c_begin = new TCanvas("c_begin","c_begin",600,600);
  TCanvas* c_end   = new TCanvas("c_end","c_end",600,600);
  TCanvas* cans_L2L3 = new TCanvas("cans_L2L3","cans_L2L3",1500,1000);
  cans_L2L3->Divide(3,2);

  c_begin->Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans_L2L3->cd(1);
      h2_L2L3_Geo[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(2);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][0].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][0].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][0].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][0]->Draw("SAME");

      cans_L2L3->cd(3);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][1].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][1].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][1].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][1]->Draw("SAME");

      cans_L2L3->cd(4);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][2].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][2].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][2].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][2]->Draw("SAME");

      cans_L2L3->cd(5);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][3].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][3].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][3].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][3]->Draw("SAME");

      cans_L2L3->cd(6);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][4].Draw("COL");
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][4].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL2BL2F_Discard[ssdindex][csiindex][4].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][4]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans_L2L3->Print(pathPDFOut.c_str());
    }
  }
  c_end->Print(pathPDFOutEnd.c_str());

}


//______________________________________________________________________________
// 考察 EneL1SL2F 能量约束条件对 "丢弃"事件的影响
void DecodefGlobalMulti1::GlobalMulti_L2L3_EneL1SL2F_Discard()
{
  Int_t globalmulti = 1;
  Int_t ssdnum, csinum, bananacut_telnum;
  Double_t el1s, el2f, el2b, ecsi;
  Int_t MAXPARTICLES = 20;

  Int_t nratio = 5;
  Double_t EL1SL2FRatio[5] = {0.50,0.60,0.70,0.80,0.90};
  Double_t lost_ratio[NUM_SSD][NUM_CSI][5] = {{{0}}};
  Double_t lost_ratio_ave[NUM_SSD][NUM_CSI] = {{0}};
  Double_t lost_ratio_sum[NUM_SSD][NUM_CSI] = {{0}};
  Double_t lost_ratio_csi_sum[NUM_CSI][5] = {{0}};
  Double_t lost_ratio_csi_ave[NUM_CSI][5] = {{0}};

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_EneL1SL2F_GlobalMulti%d_Discard.pdf",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_EneL1SL2F_GlobalMulti%d_Discard.pdf[",PATHFIGURESFOLDER,globalmulti));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_EneL1SL2F_GlobalMulti%d_Discard.pdf]",PATHFIGURESFOLDER,globalmulti));

  TH2F h2_L2L3_Geo[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_Geo_EneL1SL2F_Discard[NUM_SSD][NUM_CSI][5];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_Geo[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),Form("SSD%d_CsI%d_Geo",ssdindex+1,csiindex),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      for (Int_t iratio=0; iratio<nratio; iratio++) {
          h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][iratio] = TH2F(Form("SSD%d_CsI%d_Geo_EneL1SL2F%.2f_Discard",ssdindex+1,csiindex,EL1SL2FRatio[iratio]),
            Form("SSD%d_CsI%d_Geo_EneL1SL2F%.2f_Discard",ssdindex+1,csiindex,EL1SL2FRatio[iratio]),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      }
    }
  }

//  trackreconstruct->fChainTrackTree->SetEntries(1000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }

      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        h2_L2L3_Geo[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
        // 不满足 L1S_L2F 能量关联
        for (Int_t iratio=0; iratio<nratio; iratio++) {
          if (!(trackreconstruct->IsEneConstraint_L1S_L2F(L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0], EL1SL2FRatio[iratio]))) {
            h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][L2L3_CsINum[ssdindex][0]][iratio].Fill(L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]);
          }
        }
      }
    }
  }

  // 计算“丢失”事件的比例
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      for (Int_t iratio=0; iratio<nratio; iratio++) {
        lost_ratio[ssdindex][csiindex][iratio] = (Double_t) h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][iratio].GetEntries()/h2_L2L3_Geo[ssdindex][csiindex].GetEntries()*100;
        lost_ratio_sum[ssdindex][csiindex] += lost_ratio[ssdindex][csiindex][iratio];
      }
      lost_ratio_ave[ssdindex][csiindex] = lost_ratio_sum[ssdindex][csiindex]/nratio;
    }
  }

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t iratio=0; iratio<nratio; iratio++) {
      for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
        lost_ratio_csi_sum[ssdindex][iratio] += lost_ratio[ssdindex][csiindex][iratio];
      }
      lost_ratio_csi_ave[ssdindex][iratio] = lost_ratio_csi_sum[ssdindex][iratio]/NUM_CSI;
      cout<<Form("SSD%d_L1L2_Ratio%.2f = %.4f",ssdindex+1,EL1SL2FRatio[iratio],lost_ratio_csi_ave[ssdindex][iratio])<<endl;
    }
  }

  // 定义 latex
  TLatex* latex_ratio[NUM_SSD][NUM_CSI][nratio];
  TLatex* latex_ratio_ave[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      Double_t x1 = 0.3 * h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->GetXmax();
      Double_t y1 = 0.9 * h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->GetXmax();
      Double_t x2 = 0.3 * h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->GetXmax();
      Double_t y2 = 0.8 * h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->GetXmax();
      latex_ratio_ave[ssdindex][csiindex] = new TLatex(x1, y1, Form("#bar{r_{lost}} = %.4f%%",lost_ratio_ave[ssdindex][csiindex]));
      latex_ratio_ave[ssdindex][csiindex]->SetTextSize(0.05);
      latex_ratio_ave[ssdindex][csiindex]->SetTextColor(kRed);

      for (Int_t iratio=0; iratio<nratio; iratio++) {
        latex_ratio[ssdindex][csiindex][iratio] = new TLatex(x2, y2, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex][csiindex][iratio]));
        latex_ratio[ssdindex][csiindex][iratio]->SetTextSize(0.05);
        latex_ratio[ssdindex][csiindex][iratio]->SetTextColor(kRed);
      }
    }
  }

  // 画图
  TCanvas* c_begin = new TCanvas("c_begin","c_begin",600,600);
  TCanvas* c_end   = new TCanvas("c_end","c_end",600,600);
  TCanvas* cans_L2L3 = new TCanvas("cans_L2L3","cans_L2L3",1500,1000);
  cans_L2L3->Divide(3,2);

  c_begin->Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans_L2L3->cd(1);
      h2_L2L3_Geo[ssdindex][csiindex].Draw("COL");
      h2_L2L3_Geo[ssdindex][csiindex].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo[ssdindex][csiindex].GetYaxis()->SetNdivisions(506);

      cans_L2L3->cd(2);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][0].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][0].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][0].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][0]->Draw("SAME");

      cans_L2L3->cd(3);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][1].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][1].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][1].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][1]->Draw("SAME");

      cans_L2L3->cd(4);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][2].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][2].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][2].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][2]->Draw("SAME");

      cans_L2L3->cd(5);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][3].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][3].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][3].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][3]->Draw("SAME");

      cans_L2L3->cd(6);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][4].Draw("COL");
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][4].GetXaxis()->SetNdivisions(506);
      h2_L2L3_Geo_EneL1SL2F_Discard[ssdindex][csiindex][4].GetYaxis()->SetNdivisions(506);
      latex_ratio_ave[ssdindex][csiindex]->Draw("SAME");
      latex_ratio[ssdindex][csiindex][4]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans_L2L3->Print(pathPDFOut.c_str());
    }
  }
  c_end->Print(pathPDFOutEnd.c_str());
}

//oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo



//oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
//                        fGlobalMulti = 2
//                    ------------------------
// 解码 fGlobalMulit = 2的事件
DecodefGlobalMulti2::DecodefGlobalMulti2(Int_t firstrun, Int_t lastrun)
{
  fFirstRun = firstrun;
  fLastRun = lastrun;

  trackreconstruct = new CSHINETrackReconstruction(fFirstRun, fLastRun);

  std::string pathBananaCut(Form("%sStraighteningData/L2L3DEECuts.root",PATHROOTFILESFOLDER));
  TFile* myfile = TFile::Open(pathBananaCut.c_str());
  // 读取 bananacut
  for (Int_t numtel=0; numtel<NUM_SSD*NUM_CSI; numtel++) {
    TIter next(myfile->GetListOfKeys());
    TKey* key;
    while ((key = (TKey*) next())) {
      TCutG* cut = (TCutG*) key->ReadObj();
      std::string cutname(cut->GetName());

      if (strstr(cutname.c_str(), Form("_Tel%02d_",numtel)) != NULL) {
        bananacut[numtel].push_back(cut);
      //  cout<<cut->GetName()<<endl;
      }
    }
  }
}

DecodefGlobalMulti2::~DecodefGlobalMulti2()
{}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti2::GlobalMulti2_Checks()
{
  gROOT->cd();

  Int_t gmulti = 2;
  const char* gmultitag = "fGlobalMulti2";
  trackreconstruct->L2L3_CheckParallelDraw(gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL2L3DEEPlot (gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL1L2DEEPlot (gmultitag, gmulti);
}


//______________________________________________________________________________
// Decode 策略:
// 直接判断
void DecodefGlobalMulti2::GlobalMulti2_Decode_1111()
{
  const Int_t globalmulti = 2;
  const char* mode = "1111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname;

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //__________________________________________________________________
            //        以下部分为当前 L2L3-globalomulti2-1111 模式的径迹重建策略！！！
            //       ---------------------------------------------------------
            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname,L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_corrected[ssdindex]++;

              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
                candimulti_sum[ssdindex]++;
                candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
              }
              else { // 否则, 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
                  }
                }
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] == 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
            }
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
//  考虑 L2F 双击
void DecodefGlobalMulti2::GlobalMulti2_Decode_1101()
{
  const Int_t globalmulti = 2;
  const char* mode = "1101";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  Double_t EL2B_Sum;

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L2FDoubleHit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode),globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L2FDoubleHit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L2FDoubleHit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L2FDoubleHit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //           以下部分为当前 L2L3-globalomulti2-1101 模式的径迹重建策略！！！
          //          -------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL2B_Sum = L2L3_L2BEMeV[ssdindex][0] + L2L3_L2BEMeV[ssdindex][1];
            // 考虑 L2F 双击
            if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,EL2B_Sum,L2L3_L2FEMeV[ssdindex][0])) {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname,L2L3_CSIECh[ssdindex][itrack],L2L3_L2BEMeV[ssdindex][itrack])) {
                  //
                  candimulti_corrected[ssdindex]++;
                  //
                  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2BEMeV[ssdindex][itrack]);
                  // 如果满足 EL1S_EL2F, 则直接填充
                  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2BEMeV[ssdindex][itrack])) {
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
                  }
                  else { // 利用 LISE++ 反推 L1S_ELoss
                    trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                    if (L2L3_L2BEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
                      L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2BEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                      if (L2F_Einc > Condition_L2FEincCut) {
                        L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                        h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L1S_ELoss);
                      }
                    }
                  }
                }
              }
            }
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2BEMeV[ssdindex][0]))
            {
              //
              candimulti_corrected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2BEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2BEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2BEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2BEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2BEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2BEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname,L2L3_CSIECh[ssdindex][1],L2L3_L2BEMeV[ssdindex][1]))
            {
              //
              candimulti_corrected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2BEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2BEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2BEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2BEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2BEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2BEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            else { // 两条径迹都不满足 BananaCut
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          //
          if (candimulti_corrected[ssdindex] == 2) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_L2FDoubleHit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L2FDoubleHit[ssdindex][csiindex],"2hit/sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }


  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L2FDoubleHit[ssdindex][csiindex]->Draw("SAME");
      h1_L2FDoubleHit[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L2FDoubleHit[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");


      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
//  考虑 L2B 双击
void DecodefGlobalMulti2::GlobalMulti2_Decode_1010()
{
  const Int_t globalmulti = 2;
  const char* mode = "1010";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corected[NUM_SSD];

  Double_t EL2F_Sum;

  std::string cutname;
  Int_t charge, mass;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L2FSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L2FSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L2FSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L2FSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      candimulti_corected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti2-1010 模式的径迹重建策略！！！
          //      -----------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL2F_Sum = L2L3_L2FEMeV[ssdindex][0] + L2L3_L2FEMeV[ssdindex][1];
            // 满足 L2B 双击情况，且至少有一条径迹满足 BananaCut
            if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],EL2F_Sum)) {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname,L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])) {
                  //
                  candimulti_corected[ssdindex]++;
                  //
                  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
                  // 利用 LISE++ 反推 L1S_ELoss
                  trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
                    L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    if (L2F_Einc > Condition_L2FEincCut) {
                      L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
                    }
                  }
                }
              }
            }
            // 其中一条径迹满足 EL2B_EL2F
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) {
              //
              candimulti_corected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            // 其中一条径迹满足 EL2B_EL2F
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname,L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) {
              //
              candimulti_corected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            else { // 其他情况, 舍弃
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
          //
          if (candimulti_corected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          // 填充满足 2hit 的 submode
          if (candimulti_corected[ssdindex] == 2) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_L2FSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L2FSharing[ssdindex][csiindex],"2hit","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L2FSharing[ssdindex][csiindex]->Draw("SAME");
      h1_L2FSharing[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L2FSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
// 直接判断
void DecodefGlobalMulti2::GlobalMulti2_Decode_1000()
{
  const Int_t globalmulti = 2;
  const char* mode = "1000";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //          以下部分为当前 L2L3-globalomulti2-1000 模式的径迹重建策略！！！
          //         -------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            // 如果只有一条径迹满足 BananaCut
            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
              //
              candimulti_corrected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 否则, 使用 LISE++ 计算 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            // 如果只有另一条径迹满足 BananaCut
            else if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname,L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
              //
              candimulti_corrected[ssdindex]++;
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else {
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            else { // 如果两条径迹都满足/都不满足 BananaCut, 则舍弃
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
// 考虑 L2B sharing
void DecodefGlobalMulti2::GlobalMulti2_Decode_0101()
{
  const Int_t globalmulti = 2;
  const char* mode = "0101";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t fgmulti, ssdnum;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  Double_t EL2B_Sum;

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L2BSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L2BSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L2BSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L2BSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //           以下部分为当前 L2L3-globalomulti2-0101 模式的径迹重建策略！！！
          //          -------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL2B_Sum = L2L3_L2BEMeV[ssdindex][0] + L2L3_L2BEMeV[ssdindex][1];
            // 考虑 L2B sharing
            if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][1])==1) &&
                 trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, EL2B_Sum, L2L3_L2FEMeV[ssdindex][0]) &&
                 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
            {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
                h1_L2BSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            else if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname,L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            else {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries()/2;
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries()/2;
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L2BSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L2BSharing[ssdindex][csiindex]->Draw("SAME");
      h1_L2BSharing[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L2BSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");


      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}



//______________________________________________________________________________
// Decode 策略:
// 考虑 L2B sharing
void DecodefGlobalMulti2::GlobalMulti2_Decode_0100()
{
  const Int_t globalmulti = 2;
  const char* mode = "0100";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t fgmulti, ssdnum;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];

  Double_t EL2B_sharing;

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L2BSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L2BSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L2BSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L2BSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //           以下部分为当前 L2L3-globalomulti2-0100 模式的径迹重建策略！！！
          //          --------------------------------------------------------
          // 考虑 L2B 的 charge sharing
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL2B_sharing = L2L3_L2BEMeV[ssdindex][0] + L2L3_L2BEMeV[ssdindex][1];
            // 考虑 L2B sharing
            if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][1])==1 &&
                 trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, EL2B_sharing, L2L3_L2FEMeV[ssdindex][0])) &&
                 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]], cutname, L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]))
            {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
                h1_L2BSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else {
                // 反推 EL1S
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            // 其中一条候选径迹满足判选条件
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]], cutname, L2L3_CSIECh[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else {
                // 反推 EL1S
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            // 其中另一条候选径迹满足判选条件
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]], cutname, L2L3_CSIECh[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 反推 EL1S
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            else { //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries()/2;
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries()/2;
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L2BSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L2BSharing[ssdindex][csiindex]->Draw("SAME");
      h1_L2BSharing[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L2BSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");


      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
// 考虑 L2F sharing
void DecodefGlobalMulti2::GlobalMulti2_Decode_0010()
{
  const Int_t globalmulti = 2;
  const char* mode = "0010";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];

  Double_t EL2F_sharing;

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L2FSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L2FSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L2FSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L2FSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //           以下部分为当前 L2L3-globalomulti2-0010 模式的径迹重建策略！！！
          //          ---------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL2F_sharing = L2L3_L2FEMeV[ssdindex][0] + L2L3_L2FEMeV[ssdindex][1];
            // 考虑 L2F charge sharing
            if (TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][1])==1 &&
                trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]], cutname, L2L3_CSIECh[ssdindex][0], EL2F_sharing) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], EL2F_sharing)) {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
                h1_L2FSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],EL2F_sharing);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], EL2F_sharing)) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_sharing,L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 否则, 利用 LISE 计算 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (EL2F_sharing>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_sharing,L1S_ELoss);
                  }
                }
              }
            }
            // 其中一条候选径迹满足 Banana Cut
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else { // 反推 EL1S
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            // 其中另一条候选径迹满足 Banana Cut
            else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
                     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname,L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
            {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              //
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 反推 EL1S
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
                  }
                }
              }
            }
            // 其他情况, 舍弃
            else {
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries()/2;
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries()/2;
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L2FSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L2FSharing[ssdindex][csiindex]->Draw("SAME");
      h1_L2FSharing[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L2FSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
// Decode 策略:
// 考虑 L1S sharing
void DecodefGlobalMulti2::GlobalMulti2_Decode_0001()
{
  const Int_t globalmulti = 2;
  const char* mode = "0001";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;


  Int_t mode_index;
  Int_t fgmulti, ssdnum;
  Int_t bin_index[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];

  Double_t EL1S_sharing;

  Int_t charge, mass;
  std::string cutname;

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_L1SSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_L1SSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_L1SSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_L1SSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      candimulti_sum[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }
      for (Int_t imulti=0; imulti<globalmulti; imulti++) { bin_index[imulti] = -1; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }

      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
                trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_sum[ssdindex]++;
              candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
            }
          }
          //____________________________________________________________________
          //           以下部分为当前 L2L3-globalomulti2-0001 模式的径迹重建策略！！！
          //          --------------------------------------------------------
          if (candimulti_sum[ssdindex]==0 || candimulti_sum[ssdindex]==1 || candimulti_sum[ssdindex]==2) {
            EL1S_sharing = L2L3_L1SEMeV[ssdindex][0] + L2L3_L1SEMeV[ssdindex][1];
            // 满足 BananaCut && EL2B_EL2F
            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname,L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
            {
              //
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
              }
              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);

              // 考虑 L1S sharing, 如果满足 EL1S_EL2F, 则直接填充
              if (TMath::Abs(L2L3_L1SStripNum[ssdindex][0]-L2L3_L1SStripNum[ssdindex][1])==1 &&
                  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, EL1S_sharing, L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],EL1S_sharing);
                //
                for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                  h1_L1SSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
                }
              }
              else if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
              }
              else if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
              }
              else { // 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
                  }
                }
              }
            }
            else { // 不同时满足 BananaCut && EL2B_EL2F, 舍弃
              for (Int_t itrack=0; itrack<globalmulti; itrack++) {
                h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
                h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries()/2;
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries()/2;
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.3 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_L1SSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      // candidatemulri sharing
      h1_L1SSharing[ssdindex][csiindex]->Draw("SAME");
      h1_L1SSharing[ssdindex][csiindex]->SetLineColor(kGreen-3);
      h1_L1SSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}
//______________________________________________________________________________



//______________________________________________________________________________
// 解码 fGlobalMulit = 3的事件
DecodefGlobalMulti3::DecodefGlobalMulti3()
{
	fFirstRun = 150;
  fLastRun  = 160;
}
//
DecodefGlobalMulti3::DecodefGlobalMulti3(Int_t firstrun, Int_t lastrun)
{
  fFirstRun = firstrun;
  fLastRun  = lastrun;

  trackreconstruct = new CSHINETrackReconstruction(fFirstRun, fLastRun);

  std::string pathBananaCut(Form("%sStraighteningData/L2L3DEECuts.root",PATHROOTFILESFOLDER));
  TFile* myfile = TFile::Open(pathBananaCut.c_str());
  // 读取 bananacut
  for (Int_t numtel=0; numtel<NUM_SSD*NUM_CSI; numtel++) {
    TIter next(myfile->GetListOfKeys());
    TKey* key;
    while ((key = (TKey*) next())) {
      TCutG* cut = (TCutG*) key->ReadObj();
      std::string cutname(cut->GetName());

      if (strstr(cutname.c_str(), Form("_Tel%02d_",numtel)) != NULL) {
        bananacut[numtel].push_back(cut);
      //  cout<<cut->GetName()<<endl;
      }
    }
  }
}

DecodefGlobalMulti3::~DecodefGlobalMulti3()
{}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Checks()
{
  gROOT->cd();

  Int_t gmulti = 3;
  const char* gmultitag = "fGlobalMulti3";
  trackreconstruct->L2L3_CheckParallelDraw(gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL2L3DEEPlot (gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL1L2DEEPlot (gmultitag, gmulti);
}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_2222()
{
	const Int_t globalmulti = 3;
  const char* mode = "2222";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname;

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  //trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);

            //__________________________________________________________________
            //        以下部分为当前 L2L3-globalomulti3-2222 模式的径迹重建策略！！！
            //       ---------------------------------------------------------
						// 直接判断
            if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname,L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
            {
              candimulti_corrected[ssdindex]++;

              // L2L3_DEE 直接填充
              h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
              // 如果满足 EL1S_EL2F, 则直接填充
              if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								candimulti_sum[ssdindex]++;
								candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
                h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
              }
              else { // 否则, 利用 LISE++ 反推 L1S_ELoss
                trackreconstruct->GetZAFromBananaCutName(cutname,charge,mass);
                if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
                  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
                  if (L2F_Einc > Condition_L2FEincCut) {
                    L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
                    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
                  }
                }
              }
            }
          }
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
					//
					if (candimulti_corrected[ssdindex] == 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }
  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_2111()
{
	const Int_t globalmulti = 3;
  const char* mode = "2111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  // trackreconstruct->fChainTrackTree->SetEntries(1000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						//
						//
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-2111 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
 							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
						  ((L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][1]))) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
						     	 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
									 ((L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][2]))) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
						     	 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
									 ((L2L3_L2BEMeV[ssdindex][1]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][1]!=L2L3_L1SEMeV[ssdindex][2]))) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) {
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
          else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) {
            candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) {
            candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}

          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}



//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1211()
{
	const Int_t globalmulti = 3;
  const char* mode = "1211";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1211 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					// 考虑 L2B sharing
          if (((L2L3_CSIECh[ssdindex][0]==L2L3_CSIECh[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]==L2L3_L2FEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]==L2L3_L1SEMeV[ssdindex][1])) &&
				      (TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][1])==1) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0]+L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
						  (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						candimulti_sharing[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
          else if (((L2L3_CSIECh[ssdindex][1]==L2L3_CSIECh[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]==L2L3_L2FEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][1]==L2L3_L1SEMeV[ssdindex][2])) &&
				           (TMath::Abs(L2L3_L2BStripNum[ssdindex][1]-L2L3_L2BStripNum[ssdindex][2])==1) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1]+L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
		 							  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
						       ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][1])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
						       ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][2])))
          {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
						       ((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][1]!=L2L3_L1SEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1121()
{
	const Int_t globalmulti = 3;
  const char* mode = "1121";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
	Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1121 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					// 考虑 L2F sharing
          if (((L2L3_CSIECh[ssdindex][0]==L2L3_CSIECh[ssdindex][1]) && (L2L3_L2BEMeV[ssdindex][0]==L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]==L2L3_L1SEMeV[ssdindex][1])) &&
				      (TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][1])==1) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2BEMeV[ssdindex][0])) &&
						  (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2BEMeV[ssdindex][2])))
					{
						candimulti_sharing[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// 对 EL2B 进行修正
								L2L3_L2BEMeV[ssdindex][itrack] = L2L3_L2BEMeV[ssdindex][itrack]*EL2B_TO_EL2F_SCALE[ssdindex];
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2BEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2BEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2BEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2BEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
          else if (((L2L3_CSIECh[ssdindex][1]==L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][1]==L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][1]==L2L3_L1SEMeV[ssdindex][2])) &&
				           (TMath::Abs(L2L3_L2FStripNum[ssdindex][1]-L2L3_L2FStripNum[ssdindex][2])==1) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2BEMeV[ssdindex][1])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
		 							  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2BEMeV[ssdindex][0])))
					{
						candimulti_sharing[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// 对 EL2B 进行修正
								L2L3_L2BEMeV[ssdindex][itrack] = L2L3_L2BEMeV[ssdindex][itrack]*EL2B_TO_EL2F_SCALE[ssdindex];
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2BEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2BEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2BEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2BEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2BEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
						       ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][1])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
						       ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][2])))
          {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
					          trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2BEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
						       ((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][1]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L1SEMeV[ssdindex][1]!=L2L3_L1SEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2FEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2FEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex, L2L3_L2FEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1112()
{
	const Int_t globalmulti = 3;
  const char* mode = "1112";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1112 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
          if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1])) &&
					    (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])))
					{
						candimulti_sharing[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][1]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2])) &&
					         (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) &&
		 						   (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						candimulti_sharing[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
				    h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
					  else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
								  L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
							    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
				    h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
					  else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
								  L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
							    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
				    h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
					  else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
								  L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
							    h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
      //
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1111()
{
	const Int_t globalmulti = 3;
  const char* mode = "1111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1111 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
          if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1]) &&(L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][1])) &&
				      (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
 							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
          /*
					else if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][2]) &&(L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][2])) &&
				           (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
          */
					else if (((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][1]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2]) &&(L2L3_L1SEMeV[ssdindex][1]!=L2L3_L1SEMeV[ssdindex][2])) &&
				           (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
 							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1110()
{
	const Int_t globalmulti = 3;
  const char* mode = "1110";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1110 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
          /*
					else if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][2])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
										trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
										trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
          */
					else if (((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2BEMeV[ssdindex][1]!=L2L3_L2BEMeV[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
										trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
									 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
										trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}



//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1020()
{
	const Int_t globalmulti = 3;
  const char* mode = "1020";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_2hit[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_Submode2Hit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_Submode2Hit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_2hit[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1020 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					// 考虑 L2B 双击
          if ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) &&
					    (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) &&
					         (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
						       (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) &&
					         (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
					         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_2hit[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_Submode2Hit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_Submode2Hit[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_Submode2Hit[ssdindex][csiindex]->Draw("SAME");
			h1_Submode2Hit[ssdindex][csiindex]->SetLineColor(kGreen);
			h1_Submode2Hit[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_1010()
{
	const Int_t globalmulti = 3;
  const char* mode = "1010";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_2hit[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_Submode2Hit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_Submode2Hit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_2hit[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1010 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
          if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1])) &&
					    (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1])) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
          /*
					else if (((L2L3_CSIECh[ssdindex][0]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][2])) &&
					         (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2])) &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=1) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
          */
					else if (((L2L3_CSIECh[ssdindex][1]!=L2L3_CSIECh[ssdindex][2]) && (L2L3_L2FEMeV[ssdindex][1]!=L2L3_L2FEMeV[ssdindex][2])) &&
					         (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2])) &&
							     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
							     trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_2hit[ssdindex]++;
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack!=0) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_2hit[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_Submode2Hit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_Submode2Hit[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_Submode2Hit[ssdindex][csiindex]->Draw("SAME");
			h1_Submode2Hit[ssdindex][csiindex]->SetLineColor(kGreen);
			h1_Submode2Hit[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_0201()
{
	const Int_t globalmulti = 3;
  const char* mode = "0201";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_2hit[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_Submode2Hit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_Submode2Hit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  // trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_2hit[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-0201 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
					    ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0]+L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][0]) && (TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][1])==1)) ||
							 (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1]+L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][0]) && (TMath::Abs(L2L3_L2BStripNum[ssdindex][1]-L2L3_L2BStripNum[ssdindex][2])==1))))
					{
						candimulti_2hit[ssdindex]++;
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_2hit[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_Submode2Hit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_Submode2Hit[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_Submode2Hit[ssdindex][csiindex]->Draw("SAME");
      h1_Submode2Hit[ssdindex][csiindex]->SetLineColor(kGreen);
      h1_Submode2Hit[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_0102()
{
	const Int_t globalmulti = 3;
  const char* mode = "0102";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  //trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-0102 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_0101()
{
	const Int_t globalmulti = 3;
  const char* mode = "0101";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-0101 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][1])==1) &&
				     	(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0]+L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][0]) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])))
					{
						candimulti_sharing[ssdindex]++;
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][1]-L2L3_L2BStripNum[ssdindex][2])==1) &&
				     	     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1]+L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][0]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])))
					{
						candimulti_sharing[ssdindex]++;
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
			h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
      h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_0020()
{
	const Int_t globalmulti = 3;
  const char* mode = "0020";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
	Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //____________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-0020 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
					// 考虑 L2F sharing
					if ((TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][1])==1) &&
				     	(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1])))
					{
						candimulti_sharing[ssdindex]++;
						candimulti_corrected[ssdindex]++;
            //
						EL2F_Sharing = L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][1];
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], EL2F_Sharing)) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2FStripNum[ssdindex][1]-L2L3_L2FStripNum[ssdindex][2])==1) &&
				           (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2])))
					{
						candimulti_sharing[ssdindex]++;
						candimulti_corrected[ssdindex]++;
						//
						EL2F_Sharing = L2L3_L2FEMeV[ssdindex][1]+L2L3_L2FEMeV[ssdindex][2];
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
									 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
			h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
      h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti3::GlobalMulti3_Decode_0002()
{
	const Int_t globalmulti = 3;
  const char* mode = "0002";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
	Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
	TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
      h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
			h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
    }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
      h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

      h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
      h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
    }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
    trackreconstruct->fChainTrackTree->GetEntry(ientry);
    timeper.PrintPercentageAndRemainingTime(ientry, nentries);

    // fill data
    for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
      L2L3_SSDNum [ssdindex].clear();
      L2L3_CsINum [ssdindex].clear();
      L2L3_CSIECh [ssdindex].clear();
      L2L3_L2BEMeV[ssdindex].clear();
      L2L3_L2FEMeV[ssdindex].clear();
      L2L3_L1SEMeV[ssdindex].clear();
      L2L3_CsINum[ssdindex].clear();
      L2L3_L2BStripNum[ssdindex].clear();
      L2L3_L2FStripNum[ssdindex].clear();
      L2L3_L1SStripNum[ssdindex].clear();
      BananaCut_TelNum[ssdindex].clear();

      // 初始化
      candimulti_sum[ssdindex] = 0;
      candimulti_corrected[ssdindex] = 0;
			candimulti_sharing[ssdindex] = 0;
      for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

      if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
        for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
          if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
            L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
            L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
            L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
            L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
            L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
            L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
            L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
            L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
            BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
          }
        }
      }
      // 填充数据
      if (L2L3_CsINum[ssdindex].size() == globalmulti) {
        mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
        if (strcmp(mode_exp.c_str(),mode) == 0) {
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
            h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

            // 填充 mode statistic
            bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
                                                                                    trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
            h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            //
						if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
                trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
								trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
            {
							candimulti_sum[ssdindex]++;
							candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
						}
					}
          //__________________________________________________________________
          //        以下部分为当前 L2L3-globalomulti3-1112 模式的径迹重建策略！！！
          //       ---------------------------------------------------------
          if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
							h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
						}
					}
          //____________________________________________________________________
          // 填充每块 CsI 的 candidate multi
          for (Int_t itrack=0; itrack<globalmulti; itrack++) {
            h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
            h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
          }
          //
          if (candimulti_corrected[ssdindex] > 0) {
            for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
            }
          }
					//
					if (candimulti_sharing[ssdindex] > 0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
						}
					}
          // 填充每一个 SSD 的 candidate multi
          h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
        }
      }
    }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
      else {
        entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
        entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
      }
    }
    lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    x1 = 0.4 * globalmulti;
    y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
    latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
    latex_ratio[ssdindex]->SetTextSize(0.05);
    latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
      //
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
      legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
			legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
      //
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
      legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
    }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
    for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
      cans.cd(1);
      h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
      if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
        for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
          bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
        }
      }

      cans.cd(2);
      h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(3);
      h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(4);
      h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
      h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
      h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
      h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
      h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
      h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
			//
      legend_SubMode[ssdindex][csiindex]->Draw("SAME");

      cans.cd(5);
      h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
      cans.cd(6);
      h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
      cans.cd(7);
      h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

      cans.cd(8);
      // candimulti_sum
      h1_candimulti_sum[ssdindex]->Draw();
      h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
      h1_candimulti_sum[ssdindex]->SetLineWidth(2);
      h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
      h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
      // candimulti_merged
      h1_candimulti_merged[ssdindex]->Draw("SAME");
      h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
      h1_candimulti_merged[ssdindex]->SetLineWidth(2);
      // candimulti
      h1_candimulti[ssdindex][csiindex]->Draw("SAME");
      h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
      h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
      // latex_ratio
      latex_ratio[ssdindex]->Draw();
      //
      legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

      gPad->Modified();
      gPad->Update();

      cans.Print(pathPDFOut.c_str());
    }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}
//______________________________________________________________________________




//______________________________________________________________________________
//______________________________________________________________________________
// 解码 fGlobalMulit = 4的事件
DecodefGlobalMulti4::DecodefGlobalMulti4()
{
	fFirstRun = 150;
  fLastRun  = 160;
}
//
DecodefGlobalMulti4::DecodefGlobalMulti4(Int_t firstrun, Int_t lastrun)
{
  fFirstRun = firstrun;
  fLastRun  = lastrun;

  trackreconstruct = new CSHINETrackReconstruction(fFirstRun, fLastRun);

  std::string pathBananaCut(Form("%sStraighteningData/L2L3DEECuts.root",PATHROOTFILESFOLDER));
  TFile* myfile = TFile::Open(pathBananaCut.c_str());
  // 读取 bananacut
  for (Int_t numtel=0; numtel<NUM_SSD*NUM_CSI; numtel++) {
    TIter next(myfile->GetListOfKeys());
    TKey* key;
    while ((key = (TKey*) next())) {
      TCutG* cut = (TCutG*) key->ReadObj();
      std::string cutname(cut->GetName());

      if (strstr(cutname.c_str(), Form("_Tel%02d_",numtel)) != NULL) {
        bananacut[numtel].push_back(cut);
      //  cout<<cut->GetName()<<endl;
      }
    }
  }
}

DecodefGlobalMulti4::~DecodefGlobalMulti4()
{}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Checks()
{
  gROOT->cd();

  Int_t gmulti = 4;
  const char* gmultitag = "fGlobalMulti4";
  trackreconstruct->L2L3_CheckParallelDraw(gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL2L3DEEPlot (gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL1L2DEEPlot (gmultitag, gmulti);
}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_2222()
{
	const Int_t globalmulti = 4;
  const char* mode = "2222";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-2222 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
          if (L2L3_CSIECh[ssdindex][0]==L2L3_CSIECh[ssdindex][1]) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					  {
						  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=1) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
						         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					  {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=0) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (((L2L3_L2BEMeV[ssdindex][2]!=L2L3_L2BEMeV[ssdindex][3]) && (L2L3_L2FEMeV[ssdindex][2]!=L2L3_L2FEMeV[ssdindex][3]) && (L2L3_L1SEMeV[ssdindex][2]!=L2L3_L1SEMeV[ssdindex][3])) &&
						         ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])) ||
											(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
 										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))))
						{
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if ((itrack!=0) && (itrack!=1)) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
	              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
	              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
	            }
						}
					}
					//
					else if (L2L3_CSIECh[ssdindex][1]==L2L3_CSIECh[ssdindex][2]) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					  {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=2) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
						         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					  {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=1) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (((L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][3]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][3]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][3])) &&
						         ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) ||
											(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
 										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))))
						{
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if ((itrack!=1) && (itrack!=2)) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
	              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
	              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
	            }
						}
					}
          //
					else if (L2L3_CSIECh[ssdindex][2]==L2L3_CSIECh[ssdindex][3]) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					  {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=3) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
						         trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					  {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if (itrack!=2) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else if (((L2L3_L2BEMeV[ssdindex][0]!=L2L3_L2BEMeV[ssdindex][1]) && (L2L3_L2FEMeV[ssdindex][0]!=L2L3_L2FEMeV[ssdindex][1]) && (L2L3_L1SEMeV[ssdindex][0]!=L2L3_L1SEMeV[ssdindex][1])) &&
						         ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) ||
											(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
 										   trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))))
						{
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							  if ((itrack!=2) && (itrack!=3)) {
									if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
									    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
									{
										candimulti_corrected[ssdindex]++;
										// L2L3_DEE 直接填充
					          h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								   // 如果满足 EL1S_EL2F, 则直接填充
									  if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
										  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							      }
										else { // 否则, 利用 LISE++ 反推 L1S_ELoss
											trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
											if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
												L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
												if (L2F_Einc > Condition_L2FEincCut) {
													L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
													h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
												}
											}
										}
									}
								}
							}
						}
						else {
							for (Int_t itrack=0; itrack<globalmulti; itrack++) {
	              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
	              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
	            }
						}
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_1111()
{
	const Int_t globalmulti = 4;
  const char* mode = "1111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-1111 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
          if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==0 || itrack==2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==0 || itrack==3) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==1 || itrack==2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==1 || itrack==3) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_1110()
{
	const Int_t globalmulti = 4;
  const char* mode = "1110";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);


				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-1110 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							(trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							 trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==0 || itrack==2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==0 || itrack==3) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==1 || itrack==2) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				            trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1])) &&
							     (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
							      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3])))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==1 || itrack==3) {
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_1011()
{
	const Int_t globalmulti = 4;
  const char* mode = "1011";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_2hit[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_Submode2Hit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_Submode2Hit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_2hit[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-1011 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
          if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]) &&
				      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
					    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
							if (itrack==0 || itrack==2) {
								candimulti_2hit[ssdindex]++;
								candimulti_corrected[ssdindex]++;
								// L2L3_DEE 直接填充
				        h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_2hit[ssdindex] == 2) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_Submode2Hit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5) || ((ssdindex==3 && csiindex==3))) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_Submode2Hit[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_Submode2Hit[ssdindex][csiindex]->Draw("SAME");
		  h1_Submode2Hit[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_Submode2Hit[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_0111()
{
	const Int_t globalmulti = 4;
  const char* mode = "0111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-0111 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				      trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_0110()
{
	const Int_t globalmulti = 4;
  const char* mode = "0110";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Double_t EL2F_Sharing;
	Double_t EL2B_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-0110 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					EL2F_Sharing = L2L3_L2FEMeV[ssdindex][0] + L2L3_L2FEMeV[ssdindex][3];
          EL2B_Sharing = L2L3_L2BEMeV[ssdindex][0] + L2L3_L2BEMeV[ssdindex][3];
					//
					if (((TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][3])==1) && (TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][3])==1)) &&
				      trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,EL2B_Sharing,EL2F_Sharing) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],EL2F_Sharing))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], EL2F_Sharing)) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][3])==1) &&
				            trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],EL2F_Sharing) &&
						        trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],EL2F_Sharing))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], EL2F_Sharing)) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][3])==1) &&
				            trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],EL2F_Sharing) &&
						        trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],EL2F_Sharing))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], EL2F_Sharing)) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][3])==1) &&
				            trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,EL2B_Sharing,L2L3_L2FEMeV[ssdindex][0]) &&
						        trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][3])==1) &&
				            trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,EL2B_Sharing,L2L3_L2FEMeV[ssdindex][3]) &&
						        trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_0101()
{
	const Int_t globalmulti = 4;
  const char* mode = "0101";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2B_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-0101 模式的径迹重建策略！！！
 			  	//       ---------------------------------------------------------
					EL2B_Sharing = L2L3_L2BEMeV[ssdindex][0] + L2L3_L2BEMeV[ssdindex][3];
          if ((TMath::Abs(L2L3_L2BStripNum[ssdindex][0]-L2L3_L2BStripNum[ssdindex][3])==1) &&
				      trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,EL2B_Sharing,L2L3_L2FEMeV[ssdindex][0]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti4::GlobalMulti4_Decode_0011()
{
	const Int_t globalmulti = 4;
  const char* mode = "0011";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 1.0; // MeV
  Double_t Condition_L2FEincCut  = 1.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(5000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti4-0011 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					EL2F_Sharing = L2L3_L2FEMeV[ssdindex][0] + L2L3_L2FEMeV[ssdindex][3];
          if ((TMath::Abs(L2L3_L2FStripNum[ssdindex][0]-L2L3_L2FStripNum[ssdindex][3])==1) &&
				      trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],EL2F_Sharing) &&
							trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],EL2F_Sharing))
					{
						candimulti_corrected[ssdindex]++;
						candimulti_sharing[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],EL2F_Sharing);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], EL2F_Sharing)) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (EL2F_Sharing>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,EL2F_Sharing,"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(EL2F_Sharing,L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
								}
							}
						}
					}
					else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
				           trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
					{
						candimulti_corrected[ssdindex]++;
						// L2L3_DEE 直接填充
						h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
						// 如果满足 EL1S_EL2F, 则直接填充
						if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
							h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
						}
						else { // 否则, 利用 LISE++ 反推 L1S_ELoss
							trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
							if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
								L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
								if (L2F_Einc > Condition_L2FEincCut) {
									L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
								}
							}
						}
					}
					else {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}
//______________________________________________________________________________



//______________________________________________________________________________
//______________________________________________________________________________
// 解码 fGlobalMulit = 6的事件
DecodefGlobalMulti6::DecodefGlobalMulti6()
{
	fFirstRun = 150;
  fLastRun  = 160;
}
//
DecodefGlobalMulti6::DecodefGlobalMulti6(Int_t firstrun, Int_t lastrun)
{
  fFirstRun = firstrun;
  fLastRun  = lastrun;

  trackreconstruct = new CSHINETrackReconstruction(fFirstRun, fLastRun);

  std::string pathBananaCut(Form("%sStraighteningData/L2L3DEECuts.root",PATHROOTFILESFOLDER));
  TFile* myfile = TFile::Open(pathBananaCut.c_str());
  // 读取 bananacut
  for (Int_t numtel=0; numtel<NUM_SSD*NUM_CSI; numtel++) {
    TIter next(myfile->GetListOfKeys());
    TKey* key;
    while ((key = (TKey*) next())) {
      TCutG* cut = (TCutG*) key->ReadObj();
      std::string cutname(cut->GetName());

      if (strstr(cutname.c_str(), Form("_Tel%02d_",numtel)) != NULL) {
        bananacut[numtel].push_back(cut);
      //  cout<<cut->GetName()<<endl;
      }
    }
  }
}

DecodefGlobalMulti6::~DecodefGlobalMulti6()
{}
//______________________________________________________________________________


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Checks()
{
  gROOT->cd();

  Int_t gmulti = 6;
  const char* gmultitag = "fGlobalMulti6";
  trackreconstruct->L2L3_CheckParallelDraw(gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL2L3DEEPlot (gmultitag, gmulti);
  trackreconstruct->L2L3_CheckL1L2DEEPlot (gmultitag, gmulti);
}
//______________________________________________________________________________



//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_2222()
{
	const Int_t globalmulti = 6;
  const char* mode = "2222";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  // trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-2222 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// 自考虑  ---01---23---45----
					if ((L2L3_CsINum[ssdindex][0]==L2L3_CsINum[ssdindex][1]) && (L2L3_CsINum[ssdindex][2]==L2L3_CsINum[ssdindex][3]) && (L2L3_CsINum[ssdindex][4]==L2L3_CsINum[ssdindex][5]))
					{
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]) &&
							  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][0]],cutname[0],L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]))
						{
	            candimulti_corrected[ssdindex]++;
							//
						  //	cout<<"ientry="<<ientry<<setw(15)<<"CsINum[0]="<<L2L3_CsINum [ssdindex][0]<<setw(15)<<"EL2B[0]="<<L2L3_L2BEMeV[ssdindex][0]<<setw(15)<<"EL2F[0]="<<L2L3_L2FEMeV[ssdindex][0]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_CSIECh[ssdindex][0],L2L3_L2FEMeV[ssdindex][0]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][0], L2L3_L2FEMeV[ssdindex][0])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L2L3_L1SEMeV[ssdindex][0]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[0],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][0]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][0],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][0]].Fill(L2L3_L2FEMeV[ssdindex][0],L1S_ELoss);
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]) &&
							       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][1]],cutname[1],L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]))
						{
	            candimulti_corrected[ssdindex]++;
							//
							// cout<<"ientry="<<ientry<<setw(15)<<"CsINum[1]="<<L2L3_CsINum [ssdindex][1]<<setw(15)<<"EL2B[1]="<<L2L3_L2BEMeV[ssdindex][1]<<setw(15)<<"EL2F[1]="<<L2L3_L2FEMeV[ssdindex][1]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_CSIECh[ssdindex][1],L2L3_L2FEMeV[ssdindex][1]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][1], L2L3_L2FEMeV[ssdindex][1])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L2L3_L1SEMeV[ssdindex][1]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[1],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][1]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][1],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][1]].Fill(L2L3_L2FEMeV[ssdindex][1],L1S_ELoss);
									}
								}
							}
						}
						// 在 2,3 中挑选至多一条径迹
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]) &&
							  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][2]],cutname[2],L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]))
						{
	            candimulti_corrected[ssdindex]++;
							//
							// cout<<"ientry="<<ientry<<setw(15)<<"CsINum[2]="<<L2L3_CsINum [ssdindex][2]<<setw(15)<<"EL2B[2]="<<L2L3_L2BEMeV[ssdindex][2]<<setw(15)<<"EL2F[2]="<<L2L3_L2FEMeV[ssdindex][2]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_CSIECh[ssdindex][2],L2L3_L2FEMeV[ssdindex][2]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][2], L2L3_L2FEMeV[ssdindex][2])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L2L3_L1SEMeV[ssdindex][2]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[2],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][2]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][2],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][2]].Fill(L2L3_L2FEMeV[ssdindex][2],L1S_ELoss);
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]) &&
							       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][3]],cutname[3],L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]))
						{
	            candimulti_corrected[ssdindex]++;
							//
							// cout<<"ientry="<<ientry<<setw(15)<<"CsINum[3]="<<L2L3_CsINum [ssdindex][3]<<setw(15)<<"EL2B[3]="<<L2L3_L2BEMeV[ssdindex][3]<<setw(15)<<"EL2F[3]="<<L2L3_L2FEMeV[ssdindex][3]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_CSIECh[ssdindex][3],L2L3_L2FEMeV[ssdindex][3]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][3], L2L3_L2FEMeV[ssdindex][3])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L2L3_L1SEMeV[ssdindex][3]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[3],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][3]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][3],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][3]].Fill(L2L3_L2FEMeV[ssdindex][3],L1S_ELoss);
									}
								}
							}
						}
						// 在 4,5 中挑选至多一条径迹
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][4],L2L3_L2FEMeV[ssdindex][4]) &&
							  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][4]],cutname[4],L2L3_CSIECh[ssdindex][4],L2L3_L2FEMeV[ssdindex][4]))
						{
							candimulti_corrected[ssdindex]++;
							//
							// cout<<"ientry="<<ientry<<setw(15)<<"CsINum[4]="<<L2L3_CsINum [ssdindex][4]<<setw(15)<<"EL2B[4]="<<L2L3_L2BEMeV[ssdindex][4]<<setw(15)<<"EL2F[4]="<<L2L3_L2FEMeV[ssdindex][4]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][4]].Fill(L2L3_CSIECh[ssdindex][4],L2L3_L2FEMeV[ssdindex][4]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][4], L2L3_L2FEMeV[ssdindex][4])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][4]].Fill(L2L3_L2FEMeV[ssdindex][4],L2L3_L1SEMeV[ssdindex][4]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[4],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][4]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][4],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][4]].Fill(L2L3_L2FEMeV[ssdindex][4],L1S_ELoss);
									}
								}
							}
						}
						else if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][5],L2L3_L2FEMeV[ssdindex][5]) &&
							       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][5]],cutname[5],L2L3_CSIECh[ssdindex][5],L2L3_L2FEMeV[ssdindex][5]))
						{
							candimulti_corrected[ssdindex]++;
							//
							// cout<<"ientry="<<ientry<<setw(15)<<"CsINum[5]="<<L2L3_CsINum [ssdindex][5]<<setw(15)<<"EL2B[5]="<<L2L3_L2BEMeV[ssdindex][5]<<setw(15)<<"EL2F[5]="<<L2L3_L2FEMeV[ssdindex][5]<<endl;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][5]].Fill(L2L3_CSIECh[ssdindex][5],L2L3_L2FEMeV[ssdindex][5]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][5], L2L3_L2FEMeV[ssdindex][5])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][5]].Fill(L2L3_L2FEMeV[ssdindex][5],L2L3_L1SEMeV[ssdindex][5]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[5],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][5]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][5],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][5]].Fill(L2L3_L2FEMeV[ssdindex][5],L1S_ELoss);
									}
								}
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
					if (candimulti_corrected[ssdindex] == 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
						  h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
					  }
				  }
					//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1211()
{
	const Int_t globalmulti = 6;
  const char* mode = "1211";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
				  //__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1211 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							// cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012--345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012--345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  //
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
					//
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1121()
{
	const Int_t globalmulti = 6;
  const char* mode = "1121";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1121 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1112()
{
	const Int_t globalmulti = 6;
  const char* mode = "1112";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1112 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1111()
{
	const Int_t globalmulti = 6;
  const char* mode = "1111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1111 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1110()
{
	const Int_t globalmulti = 6;
  const char* mode = "1110";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1110 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
								  L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012----345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012--345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						    trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								//
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
								if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_1011()
{
	const Int_t globalmulti = 6;
  const char* mode = "1011";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_Submode2Hit[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_Submode2Hit[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_Submode2Hit_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	 // timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-1011 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					// ---0--12345---
					// cout<<"ientry="<<ientry<<setw(15)<<( (L2L3_L2FEMeV[ssdindex][0]==L2L3_L2FEMeV[ssdindex][2]) ? 1 : 0)<<endl;
					if (L2L3_CsINum[ssdindex][0]!=L2L3_CsINum[ssdindex][1])
					{
						//
						for (Int_t itrack=0; itrack<1; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2])) &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=1; itrack<globalmulti; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2])) &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							  break;
							}
						}
					}
					// ---01--2345---
					else if (L2L3_CsINum[ssdindex][1]!=L2L3_CsINum[ssdindex][2])
					{
						//
						for (Int_t itrack=0; itrack<2; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=2; itrack<globalmulti; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01--2345---"<<endl;
							  break;
							}
						}
					}
					/// ---012--345---
					else if (L2L3_CsINum[ssdindex][2]!=L2L3_CsINum[ssdindex][3])
				  {
						//
						for (Int_t itrack=0; itrack<3; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012--345---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=3; itrack<globalmulti; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---012--345---"<<endl;
							  break;
							}
						}
					}
					// ---0123--45---
					else if (L2L3_CsINum[ssdindex][3]!=L2L3_CsINum[ssdindex][4])
				  {
						//
						for (Int_t itrack=0; itrack<4; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=4; itrack<globalmulti; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0123--45---"<<endl;
							  break;
							}
						}
					}
					// ---01234--5---
					else if (L2L3_CsINum[ssdindex][4]!=L2L3_CsINum[ssdindex][5])
				  {
						//
						for (Int_t itrack=0; itrack<5; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								  trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
								break;
							}
						}
						//
						for (Int_t itrack=5; itrack<globalmulti; itrack++) {
							if ((trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) ||
								   trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][0]+L2L3_L2FEMeV[ssdindex][2]))  &&
						       trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
							{
								candimulti_corrected[ssdindex]++;
							  // L2L3_DEE 直接填充
								h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
								// 如果满足 EL1S_EL2F, 则直接填充
								if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
									h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
								}
								else { // 否则, 利用 LISE++ 反推 L1S_ELoss
									trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
									if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
										L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
										if (L2F_Einc > Condition_L2FEincCut) {
											L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
											h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
										}
									}
								}
							  // cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---01234--5---"<<endl;
							  break;
							}
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_corrected[ssdindex]==2) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_Submode2Hit[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_Submode2Hit[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_Submode2Hit[ssdindex][csiindex]->Draw("SAME");
		  h1_Submode2Hit[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_Submode2Hit[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0211()
{
	const Int_t globalmulti = 6;
  const char* mode = "0211";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0211 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0121()
{
	const Int_t globalmulti = 6;
  const char* mode = "0121";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0121 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0120()
{
	const Int_t globalmulti = 6;
  const char* mode = "0120";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0120 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0112()
{
	const Int_t globalmulti = 6;
  const char* mode = "0112";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0112 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0111()
{
	const Int_t globalmulti = 6;
  const char* mode = "0111";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0111 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0021()
{
	const Int_t globalmulti = 6;
  const char* mode = "0021";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0021 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}


//______________________________________________________________________________
void DecodefGlobalMulti6::GlobalMulti6_Decode_0012()
{
	const Int_t globalmulti = 6;
  const char* mode = "0012";
  std::string mode_exp;

  Double_t Condition_L2FElossCut = 0.0; // MeV
  Double_t Condition_L2FEincCut  = 0.0; // MeV
  Double_t LISE_Presision = 0.5;

  Double_t L2F_Einc;
  Double_t L1S_ELoss;
  Double_t L1S_ECalc_EReal_ErrCut = 0.10;
  Double_t EL2F_Sharing;

  Int_t mode_index;
  Int_t bin_index[globalmulti];

  Int_t charge, mass;
  std::string cutname[globalmulti];

  Double_t lost_ratio[NUM_SSD] = {0};
  Int_t candmulti_csi[NUM_SSD][NUM_CSI];
  Int_t candimulti_sum[NUM_SSD];
  Int_t candimulti_merged[NUM_SSD];
  Int_t candimulti_corrected[NUM_SSD];
  Int_t candimulti_sharing[NUM_SSD];

  std::string pathPDFOut(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutBegin(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf[",PATHFIGURESFOLDER,globalmulti,mode));
  std::string pathPDFOutEnd(Form("%sfigure_TrackReconstruction/L2L3_GlobalMulti%d_Decode_%s.pdf]",PATHFIGURESFOLDER,globalmulti,mode));

  TH1I* h1_modestat[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeCorrected[NUM_SSD][NUM_CSI];
  TH1I* h1_SubmodeSharing[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti[NUM_SSD][NUM_CSI];
  TH1I* h1_candimulti_sum[NUM_SSD];
  TH1I* h1_candimulti_merged[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  h1_candimulti_sum[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  h1_candimulti_merged[ssdindex] = new TH1I(Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), Form("SSD%d_CandiMulti_Merged_%s",ssdindex+1,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h1_modestat[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_ModeStat_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeCorrected[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeCorrected_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_SubmodeSharing[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_SubmodeSharing_%s",ssdindex+1,csiindex,mode), 8, -0.5, 7.5);
		  h1_candimulti[ssdindex][csiindex] = new TH1I(Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), Form("SSD%d_CsI%d_CandiMulti_%s",ssdindex+1,csiindex,mode), globalmulti+1, -0.5, globalmulti+0.5);
	  }
  }

  TH2F h2_L2L3_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L2L3_DEE_Discard[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[NUM_SSD][NUM_CSI];
  TH2F h2_L1L2_DEE_Discard[NUM_SSD][NUM_CSI];

  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  h2_L2L3_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Cuts_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L2L3_Discard_%s",ssdindex+1,csiindex,mode),4000,0,4000,NBinsL2[ssdindex],0,EL2Range[ssdindex]);

		  h2_L1L2_DEE[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Cuts_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex] = TH2F(Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),Form("SSD%d_CsI%d_L1L2_Discard_%s",ssdindex+1,csiindex,mode),NBinsL2[ssdindex],0,EL2Range[ssdindex],NBinsL1[ssdindex],0,EL1Range[ssdindex]);
	  }
  }

  trackreconstruct->fChainTrackTree->SetEntries(10000000);
  Long64_t nentries = trackreconstruct->fChainTrackTree->GetEntries();
  cout<<"Found nentries = "<<nentries<<endl;
  cout<<Form("Processing mode%s ......",mode)<<endl;

  for (Long64_t ientry=0; ientry<nentries; ientry++) {
	  trackreconstruct->fChainTrackTree->GetEntry(ientry);
	  timeper.PrintPercentageAndRemainingTime(ientry, nentries);

  	// fill data
	  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
		  L2L3_SSDNum [ssdindex].clear();
		  L2L3_CsINum [ssdindex].clear();
		  L2L3_CSIECh [ssdindex].clear();
		  L2L3_L2BEMeV[ssdindex].clear();
		  L2L3_L2FEMeV[ssdindex].clear();
		  L2L3_L1SEMeV[ssdindex].clear();
		  L2L3_CsINum[ssdindex].clear();
		  L2L3_L2BStripNum[ssdindex].clear();
		  L2L3_L2FStripNum[ssdindex].clear();
		  L2L3_L1SStripNum[ssdindex].clear();
		  BananaCut_TelNum[ssdindex].clear();

	  	// 初始化
		  candimulti_sum[ssdindex] = 0;
		  candimulti_corrected[ssdindex] = 0;
		  candimulti_sharing[ssdindex] = 0;
		  for(Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) { candmulti_csi[ssdindex][csiindex] = 0; }

		  if (trackreconstruct->fTrackEvent.fSSDGlobalMulti[ssdindex] == globalmulti) {
			  for (Int_t gmulti=0; gmulti<trackreconstruct->fTrackEvent.fGlobalMulti; gmulti++) {
				  if (trackreconstruct->fTrackEvent.fGSSDNum[gmulti] == ssdindex) {
				    L2L3_CSIECh [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsIECh[gmulti]);
				  	L2L3_L2BEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BEMeV[gmulti]);
					  L2L3_L2FEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FEMeV[gmulti]);
					  L2L3_L1SEMeV[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SEMeV[gmulti]);
					  L2L3_CsINum [ssdindex].push_back(trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
					  L2L3_L2BStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2BNumStrip[gmulti]);
					  L2L3_L2FStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL2FNumStrip[gmulti]);
					  L2L3_L1SStripNum[ssdindex].push_back(trackreconstruct->fTrackEvent.fGL1SNumStrip[gmulti]);
					  BananaCut_TelNum[ssdindex].push_back(ssdindex*NUM_CSI+trackreconstruct->fTrackEvent.fGCsINum[gmulti]);
				  }
			  }
	  	}
		  // 填充数据
	  	if (L2L3_CsINum[ssdindex].size() == globalmulti) {
		  	mode_exp = trackreconstruct->L2L3_CalcModeFromExpData(globalmulti,L2L3_CsINum[ssdindex],L2L3_L2BStripNum[ssdindex],L2L3_L2FStripNum[ssdindex],L2L3_L1SStripNum[ssdindex]);
			  if (strcmp(mode_exp.c_str(),mode) == 0) {
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h2_L2L3_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
				  	h2_L1L2_DEE[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);

				  	// 填充 mode statistic
				  	bin_index[itrack] = trackreconstruct->L2L3_GetSubModeFromEneConstraints(trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]),
																																								  	trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex,L2L3_L1SEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]));
				  	h1_modestat[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  //
					  if (trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack])  &&
							  trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
							  trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]))
					  {
						  candimulti_sum[ssdindex]++;
						  candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]++;
					  }
				  }
					//__________________________________________________________________
			  	//        以下部分为当前 L2L3-globalomulti6-0012 模式的径迹重建策略！！！
			  	//       ---------------------------------------------------------
					for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						if (trackreconstruct->IsEneConstraint_L2B_L2F(ssdindex,L2L3_L2BEMeV[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]) &&
						  trackreconstruct->IsInsideABananaCut(bananacut[BananaCut_TelNum[ssdindex][itrack]],cutname[itrack],L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]))
						{
							candimulti_corrected[ssdindex]++;
							// L2L3_DEE 直接填充
							h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack],L2L3_L2FEMeV[ssdindex][itrack]);
							// 如果满足 EL1S_EL2F, 则直接填充
							if (trackreconstruct->IsEneConstraint_L1S_L2F(ssdindex, L2L3_L1SEMeV[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack])) {
								h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L2L3_L1SEMeV[ssdindex][itrack]);
							}
							else { // 否则, 利用 LISE++ 反推 L1S_ELoss
								trackreconstruct->GetZAFromBananaCutName(cutname[itrack],charge,mass);
							  if (L2L3_L2FEMeV[ssdindex][itrack]>Condition_L2FElossCut) {
									L2F_Einc = fEloss.GetIncidentEnergy(charge,mass,L2L3_L2FEMeV[ssdindex][itrack],"Si",SIL2THICKNESS[ssdindex]*1000,LISE_Presision,1);
									if (L2F_Einc > Condition_L2FEincCut) {
										L1S_ELoss = fEloss.GetEnergyLossFromResidualEnergy(charge,mass,L2F_Einc,"Si",SIL1THICKNESS[ssdindex]*1000,LISE_Presision,1);
										h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack],L1S_ELoss);
									}
								}
							}
						//  cout<<"ientry="<<ientry<<setw(15)<<"itrack="<<itrack<<setw(15)<<"---0--12345---"<<endl;
							break;
						}
					}
      		//____________________________________________________________________
				  // 填充每块 CsI 的 candidate multi
				  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  h1_candimulti[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
					  h1_candimulti_merged[ssdindex]->Fill(candmulti_csi[ssdindex][L2L3_CsINum[ssdindex][itrack]]);
				  }
			  	//
				  if (candimulti_corrected[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
						  h1_SubmodeCorrected[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
					//
					if (candimulti_corrected[ssdindex]==0) {
						for (Int_t itrack=0; itrack<globalmulti; itrack++) {
              h2_L2L3_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_CSIECh[ssdindex][itrack], L2L3_L2FEMeV[ssdindex][itrack]);
              h2_L1L2_DEE_Discard[ssdindex][L2L3_CsINum[ssdindex][itrack]].Fill(L2L3_L2FEMeV[ssdindex][itrack], L2L3_L1SEMeV[ssdindex][itrack]);
            }
					}
				  //
				  if (candimulti_sharing[ssdindex] > 0) {
					  for (Int_t itrack=0; itrack<globalmulti; itrack++) {
					  	h1_SubmodeSharing[ssdindex][L2L3_CsINum[ssdindex][itrack]]->Fill(bin_index[itrack]);
					  }
				  }
				  // 填充每一个 SSD 的 candidate multi
				  h1_candimulti_sum[ssdindex]->Fill(candimulti_sum[ssdindex]);
			  }
		  }
	  }
  }

  // 计算比例
  Int_t entry_all[NUM_SSD] = {0};
  Int_t entry_discard[NUM_SSD] = {0};
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  if ((ssdindex==3 && csiindex==4) || (ssdindex==3 && csiindex==5)) continue;
		  else {
			  entry_all[ssdindex] += h2_L2L3_DEE[ssdindex][csiindex].GetEntries();
			  entry_discard[ssdindex] += h2_L2L3_DEE_Discard[ssdindex][csiindex].GetEntries();
		  }
	  }
	  lost_ratio[ssdindex] = (Double_t) entry_discard[ssdindex]/entry_all[ssdindex] * 100;
  }

  // 定义 latex
  Double_t x1,y1;
  TLatex* latex_ratio[NUM_SSD];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  x1 = 0.4 * globalmulti;
	  y1 = 0.9 * h1_candimulti_merged[ssdindex]->GetMaximum();
	  latex_ratio[ssdindex] = new TLatex(x1, y1, Form("r_{lost} = %.4f%%",lost_ratio[ssdindex]));
	  latex_ratio[ssdindex]->SetTextSize(0.05);
	  latex_ratio[ssdindex]->SetTextColor(kOrange);
  }

  // 定义 Legend
  Double_t x1_legend = 0.12, y1_legend = 0.7, x2_legend = 0.35, y2_legend = 0.89;
  TLegend* legend_SubMode[NUM_SSD][NUM_CSI];
  TLegend* legend_CandiMulti[NUM_SSD][NUM_CSI];
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  legend_SubMode[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  legend_CandiMulti[ssdindex][csiindex] = new TLegend(x1_legend,y1_legend,x2_legend,y2_legend);
		  //
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_modestat[ssdindex][csiindex],"sub-modes","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeCorrected[ssdindex][csiindex],"corrected","l");
		  legend_SubMode[ssdindex][csiindex]->AddEntry(h1_SubmodeSharing[ssdindex][csiindex],"sharing","l");
		  //
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_sum[ssdindex],"candimulti","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti_merged[ssdindex],"merged","l");
		  legend_CandiMulti[ssdindex][csiindex]->AddEntry(h1_candimulti[ssdindex][csiindex],"csi","l");
	  }
  }

  // 画图
  TCanvas c_begin("c_begin","c_begin",600,600);
  TCanvas c_end("c_end","c_end",600,600);
  TCanvas cans("cans","cans",1600,1000);
  cans.Divide(4,2);

  c_begin.Print(pathPDFOutBegin.c_str());
  for (Int_t ssdindex=0; ssdindex<NUM_SSD; ssdindex++) {
	  for (Int_t csiindex=0; csiindex<NUM_CSI; csiindex++) {
		  cans.cd(1);
		  h2_L2L3_DEE[ssdindex][csiindex].Draw("COL");
		  if (bananacut[ssdindex*NUM_CSI+csiindex].size()>1) {
			  for (Int_t ip=0; ip<bananacut[ssdindex*NUM_CSI+csiindex].size(); ip++) {
			  	bananacut[ssdindex*NUM_CSI+csiindex][ip]->Draw("SAME");
				  bananacut[ssdindex*NUM_CSI+csiindex][ip]->SetLineColor(kRed);
			  }
		  }

		  cans.cd(2);
		  h2_L2L3_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(3);
		  h2_L2L3_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(4);
		  h1_modestat[ssdindex][csiindex]->Draw("HIST TEXT");
		  h1_modestat[ssdindex][csiindex]->SetLineWidth(2);
		  h1_modestat[ssdindex][csiindex]->GetXaxis()->SetNdivisions(108);
		  h1_modestat[ssdindex][csiindex]->GetYaxis()->SetRangeUser(0, 1.3*h1_modestat[ssdindex][csiindex]->GetMaximum());
		  h1_SubmodeCorrected[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineColor(kRed);
		  h1_SubmodeCorrected[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  h1_SubmodeSharing[ssdindex][csiindex]->Draw("SAME");
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineColor(kGreen);
		  h1_SubmodeSharing[ssdindex][csiindex]->SetLineWidth(2);
		  //
		  legend_SubMode[ssdindex][csiindex]->Draw("SAME");

		  cans.cd(5);
		  h2_L1L2_DEE[ssdindex][csiindex].Draw("COL");
		  cans.cd(6);
		  h2_L1L2_DEE_EneL2BL2F_EneL1SL2F_PID[ssdindex][csiindex].Draw("COL");
		  cans.cd(7);
		  h2_L1L2_DEE_Discard[ssdindex][csiindex].Draw("COL");

		  cans.cd(8);
		  // candimulti_sum
		  h1_candimulti_sum[ssdindex]->Draw();
		  h1_candimulti_sum[ssdindex]->SetLineColor(kRed);
		  h1_candimulti_sum[ssdindex]->SetLineWidth(2);
		  h1_candimulti_sum[ssdindex]->GetXaxis()->SetNdivisions(100+globalmulti+1);
		  h1_candimulti_sum[ssdindex]->GetYaxis()->SetRangeUser(0, 1.1*h1_candimulti_merged[ssdindex]->GetMaximum());
		  // candimulti_merged
		  h1_candimulti_merged[ssdindex]->Draw("SAME");
		  h1_candimulti_merged[ssdindex]->SetLineColor(kMagenta);
		  h1_candimulti_merged[ssdindex]->SetLineWidth(2);
		  // candimulti
		  h1_candimulti[ssdindex][csiindex]->Draw("SAME");
		  h1_candimulti[ssdindex][csiindex]->SetLineColor(kBlue);
		  h1_candimulti[ssdindex][csiindex]->SetLineWidth(2);
		  // latex_ratio
		  latex_ratio[ssdindex]->Draw();
		  //
		  legend_CandiMulti[ssdindex][csiindex]->Draw("SAME");

		  gPad->Modified();
		  gPad->Update();

		  cans.Print(pathPDFOut.c_str());
	  }
  }
  c_end.Print(pathPDFOutEnd.c_str());
}
//______________________________________________________________________________
